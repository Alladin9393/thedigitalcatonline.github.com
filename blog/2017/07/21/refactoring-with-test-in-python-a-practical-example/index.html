






















<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Refactoring with tests in Python: a practical example - The Digital Cat</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Liquid tags START -->
    <!-- Liquid tags START -->
    
    <link href="http://blog.thedigitalcatonline.com/images/TheDigitalCat_favicon_32.png" rel="icon">

<link rel="canonical" href="http://blog.thedigitalcatonline.com/blog/2017/07/21/refactoring-with-test-in-python-a-practical-example/">

        <meta name="author" content="Leonardo Giordani" />
        <meta name="keywords" content="OOP,Python,Python3,refactoring,TDD,testing" />

        <meta property="og:site_name" content="The Digital Cat" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Refactoring with tests in Python: a practical example"/>
        <meta property="og:url" content="http://blog.thedigitalcatonline.com/blog/2017/07/21/refactoring-with-test-in-python-a-practical-example/"/>
        <meta property="og:description" content=""/>
        <meta property="article:published_time" content="2017-07-21" />
            <meta property="article:section" content="Programming" />
            <meta property="article:tag" content="OOP" />
            <meta property="article:tag" content="Python" />
            <meta property="article:tag" content="Python3" />
            <meta property="article:tag" content="refactoring" />
            <meta property="article:tag" content="TDD" />
            <meta property="article:tag" content="testing" />
            <meta property="article:author" content="Leonardo Giordani" />


    <!-- Bootstrap and Bootswatch CSS START -->
            <link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.5/spacelab/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap and Bootswatch CSS END -->

    <!-- Font Awesome CSS START -->
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Font Awesome CSS END -->

    <!-- Pygments CSS START -->
    <link href="http://blog.thedigitalcatonline.com/theme/css/pygments/monokai.css" rel="stylesheet">
    <!-- Pygments CSS END -->

    <!-- Custom CSS START -->
    <!-- Custom CSS END -->
    
    <!-- Docutils CSS START -->
    <!-- Docutils CSS START -->
    


    
    <link rel="stylesheet" href="http://blog.thedigitalcatonline.com/theme/css/style.css" type="text/css"/>
    


        <link href="http://blog.thedigitalcatonline.com/atom.xml" type="application/atom+xml" rel="alternate"
              title="The Digital Cat ATOM Feed"/>



        <link href="http://blog.thedigitalcatonline.com/category/programming/atom.xml" type="application/atom+xml" rel="alternate"
              title="The Digital Cat Programming ATOM Feed"/>

    <!-- Google Analytics Universal -->
    <script type="text/javascript">
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-74364524-1', 'auto');
        ga('send', 'pageview');
    </script>
    <!-- End Google Analytics Universal Code -->

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://blog.thedigitalcatonline.com/" class="navbar-brand">


<i class="fa fa-paw fa-lg"></i>                <span class="icon-label">The Digital Cat</span>
               
            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="http://blog.thedigitalcatonline.com/pages/about.html">
                             About
                          </a></li>
                        <li class="active">
                            <a href="http://blog.thedigitalcatonline.com/category/programming/">Programming</a>
                        </li>
                        <li >
                            <a href="http://blog.thedigitalcatonline.com/category/projects/">Projects</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="http://blog.thedigitalcatonline.com/archives"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<!-- Banner START -->
<!-- Banner END -->

<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <article>
        <header class="page-header">
            <h1>
                <a href="http://blog.thedigitalcatonline.com/blog/2017/07/21/refactoring-with-test-in-python-a-practical-example/"
                   rel="bookmark"
                   title="Permalink to Refactoring with tests in Python: a practical example">
                    Refactoring with tests in Python: a practical example
                </a>
            </h1>
        </header>

        <section id="content">
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">


            <span class="label label-default">By</span>
            <a href="http://blog.thedigitalcatonline.com/authors/leonardo-giordani/">Leonardo Giordani</a>

            <span class="label label-default">On</span>
            <span class="published">
                <time datetime="2017-07-21T09:30:00+01:00"> 21/07/2017</time>
            </span>











    

        <span class="label label-default">Tags</span>
	<a href="http://blog.thedigitalcatonline.com/categories/oop/">OOP</a>
        /
	<a href="http://blog.thedigitalcatonline.com/categories/python/">Python</a>
        /
	<a href="http://blog.thedigitalcatonline.com/categories/python3/">Python3</a>
        /
	<a href="http://blog.thedigitalcatonline.com/categories/refactoring/">refactoring</a>
        /
	<a href="http://blog.thedigitalcatonline.com/categories/tdd/">TDD</a>
        /
	<a href="http://blog.thedigitalcatonline.com/categories/testing/">testing</a>
    


    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>This post contains a step-by-step example of a refactoring session guided by tests. When dealing with untested or legacy code refactoring is dangerous and tests can help us do it the right way, minimizing the amount of bugs we introduce, and possibly completely avoiding them.</p>
<p>Refactoring is not easy. It requires a double effort to understand code that others wrote, or that we wrote in the past, and moving around parts of it, simplifying it, in one word <strong>improving</strong> it, is by no means something for the faint-hearted. Like programming, refactoring has its rules and best practices, but it can be described as a mixture of technique, intuition, experience, risk.</p>
<p>Programming, after all, is craftsmanship.</p>
<h1>The starting point</h1>
<p>The simple use case I will use for this post is that of a service API that we can access, and that produces data in JSON format, namely a <strong>list</strong> of elements like the one shown here</p>
<div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s1">&#39;age&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
    <span class="s1">&#39;surname&#39;</span><span class="p">:</span> <span class="s1">&#39;Frazier&#39;</span><span class="p">,</span>
    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;John&#39;</span><span class="p">,</span>
    <span class="s1">&#39;salary&#39;</span><span class="p">:</span> <span class="s1">&#39;Â£28943&#39;</span>
<span class="p">}</span>
</pre></div>


<p>Once we convert this to a Python data structure we obtain a list of dictionaries, where <code>'age'</code> is an integer, and the remaining fields are strings.</p>
<p>Someone then wrote a class that computes some statistics on the input data. This class, called <code>DataStats</code>, provides a single method <code>stats()</code>, whose inputs are the data returned by the service (in JSON format), and two integers called <code>iage</code> and <code>isalary</code>. Those, according to the short documentation of the class, are the initial age and the initial salary used to compute the average yearly increase of the salary on the whole dataset.</p>
<p>The code is the following</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">json</span>


<span class="k">class</span> <span class="nc">DataStats</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">iage</span><span class="p">,</span> <span class="n">isalary</span><span class="p">):</span>
        <span class="c1"># iage and isalary are the starting age and salary used to</span>
        <span class="c1"># compute the average yearly increase of salary.</span>

        <span class="c1"># Compute average yearly increase</span>
        <span class="n">average_age_increase</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span>
            <span class="nb">sum</span><span class="p">([</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">-</span> <span class="n">iage</span>
        <span class="n">average_salary_increase</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span>
            <span class="nb">sum</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">-</span> <span class="n">isalary</span>

        <span class="n">yearly_avg_increase</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span>
            <span class="n">average_salary_increase</span><span class="o">/</span><span class="n">average_age_increase</span><span class="p">)</span>

        <span class="c1"># Compute max salary</span>
        <span class="n">salaries</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="s1">&#39;Â£&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">salaries</span><span class="p">))</span>

        <span class="n">max_salary</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">threshold</span><span class="p">]</span>

        <span class="c1"># Compute min salary</span>
        <span class="n">salaries</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="n">min_salary</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">]</span> <span class="o">==</span>
                      <span class="s1">&#39;Â£{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">salaries</span><span class="p">)))]</span>

        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
            <span class="s1">&#39;avg_age&#39;</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span>
            <span class="s1">&#39;avg_salary&#39;</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span>
                <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span>
            <span class="s1">&#39;avg_yearly_increase&#39;</span><span class="p">:</span> <span class="n">yearly_avg_increase</span><span class="p">,</span>
            <span class="s1">&#39;max_salary&#39;</span><span class="p">:</span> <span class="n">max_salary</span><span class="p">,</span>
            <span class="s1">&#39;min_salary&#39;</span><span class="p">:</span> <span class="n">min_salary</span>
        <span class="p">})</span>
</pre></div>


<h1>The goal</h1>
<p>It is fairly easy, even for the untrained eye, to spot some issues in the previous class. A list of the most striking ones is</p>
<ul>
<li>The class exposes a single method and has no <code>__init__()</code>, thus the same functionality could be provided by a single function.</li>
<li>The <code>stats()</code> method is too big, and performs too many tasks. This makes debugging very difficult, as there is a single inextricable piece of code that does everything.</li>
<li>There is a lot of code duplication, or at least several lines that are very similar. Most notably the two operations <code>'Â£' + str(max(salaries))</code> and <code>'Â£{}'.format(str(min(salaries)))</code>, the two different lines starting with <code>salaries =</code>, and the several list comprehensions.</li>
</ul>
<p>So, since we are going to use this code in some part of our Amazing New Projectâ¢, we want to possibly fix these issues.</p>
<p>The class, however, is working perfectly. It has been used in production for many years and there are no known bugs, so our operation has to be a <strong>refactoring</strong>, which means that we want to write something better, preserving the behaviour of the previous object.</p>
<h1>The path</h1>
<p>In this post I want to show you how you can safely refactor such a class using tests. This is different from TDD, but the two are closely related. The class we have has not been created using TDD, as there are no tests, but we can use tests to ensure its behaviour is preserved. This should therefore be called Test Driven Refactoring (TDR).</p>
<p>The idea behind TDR is pretty simple. First, we have to write a test that checks the behaviour of some code, possibly a small part with a clearly defined scope and output. This is a posthumous (or late) unit test, and it simulates what the author of the code should have provided (cough cough, it was you some months ago...).</p>
<p>Once you have you unit test you can go and modify the code, knowing that the behaviour of the resulting object will be the same of the previous one. As you can easily understand, the effectiveness of this methodology depends strongly on the quality of the tests themselves, possibly more than when developing with TDD, and this is why refactoring is hard.</p>
<h1>Caveats</h1>
<p>Two remarks before we start our first refactoring. The first is that such a class could easily be refactored to some functional code. As you will be able to infer from the final result there is no real reason to keep an object-oriented approach for this code. I decided to go that way, however, as it gave me the possibility to show a design pattern called wrapper, and the refactoring technique that leverages it.</p>
<p>The second remark is that in pure TDD it is strongly advised not to test internal methods, that is those methods that do not form the public API of the object. In general, we identify such methods in Python by prefixing their name with an underscore, and the reason not to test them is that TDD wants you to shape objects according to the object-oriented programming methodology, which considers objects as <strong>behaviours</strong> and not as <strong>structures</strong>. Thus, we are only interested in testing public methods.</p>
<p>It is also true, however, that sometimes even tough we do not want to make a method public, that method contains some complex logic that we want to test. So, in my opinion the TDD advice should sound like "Test internal methods only when they contain some non-trivial logic".</p>
<p>When it comes to refactoring, however, we are somehow deconstructing a previously existing structure, and usually we end up creating a lot of private methods to help extracting and generalising parts of the code. My advice in this case is to test those methods, as this gives you a higher degree of confidence in what you are doing. With experience you will then learn which tests are required and which are not.</p>
<h1>Setup of the testing environment</h1>
<p>Clone <a href="https://github.com/lgiordani/datastats">this repository</a> and create a virtual environment. Activate it and install the required packages with </p>
<div class="highlight"><pre><span></span>pip install -r requirements.txt
</pre></div>


<p>The repository already contains a configuration file for pytest and you should customise it to avoid entering your virtual environment directory. Go and fix the <code>norecursedirs</code> parameter in that file, adding the name of the virtual environment you just created; I usually name my virtual environments with a <code>venv</code> prefix, and this is why that variable contains the entry <code>venv*</code>.</p>
<p>At this point you should be able to run <code>pytest -svv</code> in the parent directory of the repository (the one that contains <code>pytest.ini</code>), and obtain a result similar to the following</p>
<div class="highlight"><pre><span></span><span class="o">==========================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">==========================</span>
platform linux -- Python 3.5.3, pytest-3.1.2, py-1.4.34, pluggy-0.4.0
cachedir: .cache
rootdir: datastats, inifile: pytest.ini
plugins: cov-2.5.1
collected <span class="m">0</span> <span class="nv">items</span> 

<span class="o">======================</span> no tests ran in 0.00 <span class="nv">seconds</span> <span class="o">======================</span>
</pre></div>


<p>The given repository contains two branches. <code>master</code> is the one that you are into, and contains the initial setup, while <code>develop</code> points to the last step of the whole refactoring process. Every step of this post contains a reference to the commit that contains the changes introduced in that section.</p>
<h1>Step 1 - Testing the endpoints</h1>
<p>Commit: <a href="https://github.com/lgiordani/datastats/commit/27a1d8ccd5b0a57fa6d9d5f3bd80874538f14ed2">27a1d8c</a></p>
<p>When you start refactoring a system, regardless of the size, you have to test the endpoints. This means that you consider the system as a black box (i.e. you do not know what is inside) and just check the external behaviour. In this case we can write a test that initialises the class and runs the <code>stats()</code> method with some test data, possibly <strong>real</strong> data, and checks the output. Obviously we will write the test with the actual output returned by the method, so this test is automatically passing.</p>
<p>Querying the server we get the following data</p>
<div class="highlight"><pre><span></span><span class="n">test_data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Laith&quot;</span><span class="p">,</span>
        <span class="s2">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Simmons&quot;</span><span class="p">,</span>
        <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">68</span><span class="p">,</span>
        <span class="s2">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;Â£27888&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Mikayla&quot;</span><span class="p">,</span>
        <span class="s2">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Henry&quot;</span><span class="p">,</span>
        <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">49</span><span class="p">,</span>
        <span class="s2">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;Â£67137&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Garth&quot;</span><span class="p">,</span>
        <span class="s2">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Fields&quot;</span><span class="p">,</span>
        <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span>
        <span class="s2">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;Â£70472&quot;</span>
    <span class="p">}</span>
<span class="p">]</span>
</pre></div>


<p>and calling the <code>stats()</code> method with that output, with <code>iage</code> set to <code>20</code>, and <code>isalary</code> set to <code>20000</code>, we get the following JSON result</p>
<div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="err">&#39;avg_age&#39;:</span> <span class="err">62,</span>
    <span class="err">&#39;avg_salary&#39;:</span> <span class="err">55165,</span>
    <span class="err">&#39;avg_yearly_increase&#39;:</span> <span class="err">837,</span>
    <span class="err">&#39;max_salary&#39;:</span> <span class="err">[{</span>
        <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Garth&quot;</span><span class="p">,</span>
        <span class="nt">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Fields&quot;</span><span class="p">,</span>
        <span class="nt">&quot;age&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span>
        <span class="nt">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;Â£70472&quot;</span>
    <span class="p">}</span><span class="err">],</span>
    <span class="err">&#39;min_salary&#39;:</span> <span class="p">[{</span>
        <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Laith&quot;</span><span class="p">,</span>
        <span class="nt">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Simmons&quot;</span><span class="p">,</span>
        <span class="nt">&quot;age&quot;</span><span class="p">:</span> <span class="mi">68</span><span class="p">,</span>
        <span class="nt">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;Â£27888&quot;</span>
    <span class="p">}]</span>
<span class="err">}</span>
</pre></div>


<p>Caveat: I'm using a single very short set of real data, namely a list of 3 dictionaries. In a real case I would test the black box with many different use cases, to ensure I am not just checking some corner case.</p>
<p>The test is the following</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">datastats.datastats</span> <span class="kn">import</span> <span class="n">DataStats</span>


<span class="k">def</span> <span class="nf">test_json</span><span class="p">():</span>
    <span class="n">test_data</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Laith&quot;</span><span class="p">,</span>
            <span class="s2">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Simmons&quot;</span><span class="p">,</span>
            <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">68</span><span class="p">,</span>
            <span class="s2">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;Â£27888&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Mikayla&quot;</span><span class="p">,</span>
            <span class="s2">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Henry&quot;</span><span class="p">,</span>
            <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">49</span><span class="p">,</span>
            <span class="s2">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;Â£67137&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Garth&quot;</span><span class="p">,</span>
            <span class="s2">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Fields&quot;</span><span class="p">,</span>
            <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span>
            <span class="s2">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;Â£70472&quot;</span>
        <span class="p">}</span>
    <span class="p">]</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">DataStats</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">ds</span><span class="o">.</span><span class="n">stats</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20000</span><span class="p">)</span> <span class="o">==</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s1">&#39;avg_age&#39;</span><span class="p">:</span> <span class="mi">62</span><span class="p">,</span>
            <span class="s1">&#39;avg_salary&#39;</span><span class="p">:</span> <span class="mi">55165</span><span class="p">,</span>
            <span class="s1">&#39;avg_yearly_increase&#39;</span><span class="p">:</span> <span class="mi">837</span><span class="p">,</span>
            <span class="s1">&#39;max_salary&#39;</span><span class="p">:</span> <span class="p">[{</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Garth&quot;</span><span class="p">,</span>
                <span class="s2">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Fields&quot;</span><span class="p">,</span>
                <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span>
                <span class="s2">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;Â£70472&quot;</span>
            <span class="p">}],</span>
            <span class="s1">&#39;min_salary&#39;</span><span class="p">:</span> <span class="p">[{</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Laith&quot;</span><span class="p">,</span>
                <span class="s2">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Simmons&quot;</span><span class="p">,</span>
                <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">68</span><span class="p">,</span>
                <span class="s2">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;Â£27888&quot;</span>
            <span class="p">}]</span>
        <span class="p">}</span>
    <span class="p">)</span>
</pre></div>


<p>As said before, this test is obviously passing, having been artificially constructed from a real execution of the code.</p>
<p>Well, this test is very important! Now we know that if we change something inside the code, altering the behaviour of the class, at least one test will fail.</p>
<h1>Step 2 - Getting rid of the JSON format</h1>
<p>Commit: <a href="https://github.com/lgiordani/datastats/commit/65e2997d71ade752633229186c6669803a46f185">65e2997</a></p>
<p>The method returns its output in JSON format, and looking at the class it is pretty evident that the conversion is done by <code>json.dumps()</code>.</p>
<p>The structure of the code is the following</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DataStats</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">iage</span><span class="p">,</span> <span class="n">isalary</span><span class="p">):</span>
        <span class="p">[</span><span class="n">code_part_1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
            <span class="p">[</span><span class="n">code_part_2</span><span class="p">]</span>
        <span class="p">})</span>
</pre></div>


<p>Where obviously <code>code_part_2</code> depends on <code>code_part_1</code>. The first refactoring, then, will follow this procedure</p>
<ol>
<li>We write a test called <code>test__stats()</code> for a <code>_stats()</code> method that is supposed to return the data as a Python structure. We can infer this latter manually from the JSON or running <code>json.loads()</code> from a Python shell. The test fails.</li>
<li>We <strong>duplicate</strong> the code of the <code>stats()</code> method that produces the data, putting it in the new <code>_stats()</code> method. The test passes.</li>
</ol>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DataStats</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">_stats</span><span class="p">(</span><span class="n">parameters</span><span class="p">):</span>
        <span class="p">[</span><span class="n">code_part_1</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">code_part_2</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">iage</span><span class="p">,</span> <span class="n">isalary</span><span class="p">):</span>
        <span class="p">[</span><span class="n">code_part_1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
            <span class="p">[</span><span class="n">code_part_2</span><span class="p">]</span>
        <span class="p">})</span>
</pre></div>


<ol>
<li>We remove the duplicated code in <code>stats()</code> replacing it with a call to <code>_stats()</code></li>
</ol>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DataStats</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">_stats</span><span class="p">(</span><span class="n">parameters</span><span class="p">):</span>
        <span class="p">[</span><span class="n">code_part_1</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">code_part_2</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">iage</span><span class="p">,</span> <span class="n">isalary</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">iage</span><span class="p">,</span> <span class="n">isalary</span><span class="p">)</span>
        <span class="p">)</span>
</pre></div>


<p>At this point we could refactor the initial test <code>test_json()</code> that we wrote, but this is an advanced consideration, and I'll leave it for some later notes.</p>
<p>So now the code of our class looks like this</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DataStats</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">iage</span><span class="p">,</span> <span class="n">isalary</span><span class="p">):</span>
        <span class="c1"># iage and isalary are the starting age and salary used to</span>
        <span class="c1"># compute the average yearly increase of salary.</span>

        <span class="c1"># Compute average yearly increase</span>
        <span class="n">average_age_increase</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span>
            <span class="nb">sum</span><span class="p">([</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">-</span> <span class="n">iage</span>
        <span class="n">average_salary_increase</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span>
            <span class="nb">sum</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">-</span> <span class="n">isalary</span>

        <span class="n">yearly_avg_increase</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span>
            <span class="n">average_salary_increase</span><span class="o">/</span><span class="n">average_age_increase</span><span class="p">)</span>

        <span class="c1"># Compute max salary</span>
        <span class="n">salaries</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="s1">&#39;Â£&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">salaries</span><span class="p">))</span>

        <span class="n">max_salary</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">threshold</span><span class="p">]</span>

        <span class="c1"># Compute min salary</span>
        <span class="n">salaries</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="n">min_salary</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">]</span> <span class="o">==</span>
                      <span class="s1">&#39;Â£{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">salaries</span><span class="p">)))]</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;avg_age&#39;</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span>
            <span class="s1">&#39;avg_salary&#39;</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span>
                <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span>
            <span class="s1">&#39;avg_yearly_increase&#39;</span><span class="p">:</span> <span class="n">yearly_avg_increase</span><span class="p">,</span>
            <span class="s1">&#39;max_salary&#39;</span><span class="p">:</span> <span class="n">max_salary</span><span class="p">,</span>
            <span class="s1">&#39;min_salary&#39;</span><span class="p">:</span> <span class="n">min_salary</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">iage</span><span class="p">,</span> <span class="n">isalary</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">iage</span><span class="p">,</span> <span class="n">isalary</span><span class="p">)</span>
        <span class="p">)</span>
</pre></div>


<p>and we have two tests that check the correctness of it.</p>
<h1>Step 3 - Refactoring the tests</h1>
<p>Commit: <a href="https://github.com/lgiordani/datastats/commit/d61901754b83ccc36fa25bcebf88da7cace28ff2">d619017</a></p>
<p>It is pretty clear that the <code>test_data</code> list of dictionaries is bound to be used in every test we will perform, so it is high time we moved that to a global variable. There is no point now in using a fixture, as the test data is just static data.</p>
<p>We could also move the output data to a global variable, but the upcoming tests are not using the whole output dictionary any more, so we can postpone the decision.</p>
<p>The test suite now looks like </p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">datastats.datastats</span> <span class="kn">import</span> <span class="n">DataStats</span>


<span class="n">test_data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Laith&quot;</span><span class="p">,</span>
        <span class="s2">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Simmons&quot;</span><span class="p">,</span>
        <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">68</span><span class="p">,</span>
        <span class="s2">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;Â£27888&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Mikayla&quot;</span><span class="p">,</span>
        <span class="s2">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Henry&quot;</span><span class="p">,</span>
        <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">49</span><span class="p">,</span>
        <span class="s2">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;Â£67137&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Garth&quot;</span><span class="p">,</span>
        <span class="s2">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Fields&quot;</span><span class="p">,</span>
        <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span>
        <span class="s2">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;Â£70472&quot;</span>
    <span class="p">}</span>
<span class="p">]</span>


<span class="k">def</span> <span class="nf">test_json</span><span class="p">():</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">DataStats</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">ds</span><span class="o">.</span><span class="n">stats</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20000</span><span class="p">)</span> <span class="o">==</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s1">&#39;avg_age&#39;</span><span class="p">:</span> <span class="mi">62</span><span class="p">,</span>
            <span class="s1">&#39;avg_salary&#39;</span><span class="p">:</span> <span class="mi">55165</span><span class="p">,</span>
            <span class="s1">&#39;avg_yearly_increase&#39;</span><span class="p">:</span> <span class="mi">837</span><span class="p">,</span>
            <span class="s1">&#39;max_salary&#39;</span><span class="p">:</span> <span class="p">[{</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Garth&quot;</span><span class="p">,</span>
                <span class="s2">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Fields&quot;</span><span class="p">,</span>
                <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span>
                <span class="s2">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;Â£70472&quot;</span>
            <span class="p">}],</span>
            <span class="s1">&#39;min_salary&#39;</span><span class="p">:</span> <span class="p">[{</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Laith&quot;</span><span class="p">,</span>
                <span class="s2">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Simmons&quot;</span><span class="p">,</span>
                <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">68</span><span class="p">,</span>
                <span class="s2">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;Â£27888&quot;</span>
            <span class="p">}]</span>
        <span class="p">}</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">test__stats</span><span class="p">():</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">DataStats</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">ds</span><span class="o">.</span><span class="n">_stats</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20000</span><span class="p">)</span> <span class="o">==</span> <span class="p">{</span>
        <span class="s1">&#39;avg_age&#39;</span><span class="p">:</span> <span class="mi">62</span><span class="p">,</span>
        <span class="s1">&#39;avg_salary&#39;</span><span class="p">:</span> <span class="mi">55165</span><span class="p">,</span>
        <span class="s1">&#39;avg_yearly_increase&#39;</span><span class="p">:</span> <span class="mi">837</span><span class="p">,</span>
        <span class="s1">&#39;max_salary&#39;</span><span class="p">:</span> <span class="p">[{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Garth&quot;</span><span class="p">,</span>
            <span class="s2">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Fields&quot;</span><span class="p">,</span>
            <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span>
            <span class="s2">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;Â£70472&quot;</span>
        <span class="p">}],</span>
        <span class="s1">&#39;min_salary&#39;</span><span class="p">:</span> <span class="p">[{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Laith&quot;</span><span class="p">,</span>
            <span class="s2">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Simmons&quot;</span><span class="p">,</span>
            <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">68</span><span class="p">,</span>
            <span class="s2">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;Â£27888&quot;</span>
        <span class="p">}]</span>
    <span class="p">}</span>
</pre></div>


<h1>Step 4 - Isolate the average age algorithm</h1>
<p>Commit: <a href="https://github.com/lgiordani/datastats/commit/9db18036eee2f6712384195fcd970303387291f6">9db1803</a></p>
<p>Isolating independent features is a key target of software design. Thus, our refactoring shall aim to disentangle the code dividing it into small separated functions.</p>
<p>The output dictionary contains five keys, and each of them corresponds to a value computed either on the fly (for <code>avg_age</code> and <code>avg_salary</code>) or by the method's code (for <code>avg_yearly_increase</code>, <code>max_salary</code>, and <code>min_salary</code>). We can start replacing the code that computes the value of each key with dedicated methods, trying to isolate the algorithms.</p>
<p>To isolate some code, the first thing to do is to duplicate it, putting it into a dedicated method. As we are refactoring with tests, the first thing is to write a test for this method.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test__avg_age</span><span class="p">():</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">DataStats</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">ds</span><span class="o">.</span><span class="n">_avg_age</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">62</span>
</pre></div>


<p>We know that the method's output shall be <code>62</code> as that is the value we have in the output data of the original <code>stats()</code> method. Please note that there is no need to pass <code>iage</code> and <code>isalary</code> as they are not used in the refactored code.</p>
<p>The test fails, so we can dutifully go and duplicate the code we use to compute <code>'avg_age'</code></p>
<div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">_avg_age</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</pre></div>


<p>and once the test passes we can replace the duplicated code in <code>_stats()</code> with a call to <code>_avg_age()</code></p>
<div class="highlight"><pre><span></span>        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;avg_age&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_avg_age</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
            <span class="s1">&#39;avg_salary&#39;</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span>
                <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span>
            <span class="s1">&#39;avg_yearly_increase&#39;</span><span class="p">:</span> <span class="n">yearly_avg_increase</span><span class="p">,</span>
            <span class="s1">&#39;max_salary&#39;</span><span class="p">:</span> <span class="n">max_salary</span><span class="p">,</span>
            <span class="s1">&#39;min_salary&#39;</span><span class="p">:</span> <span class="n">min_salary</span>
        <span class="p">}</span>
</pre></div>


<p>Checking after that that no test is failing. Well done! We isolated the first feature, and our refactoring produced already three tests.</p>
<h1>Step 5 - Isolate the average salary algorithm</h1>
<p>Commit: <a href="https://github.com/lgiordani/datastats/commit/412220145ea4d7ef846b1d1f289b4ddefc4fb24b">4122201</a></p>
<p>The <code>avg_salary</code> key works exactly like the <code>avg_age</code>, with different code. Thus, the refactoring process is the same as before, and the result should be a new <code>test__avg_salary()</code> test</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test__avg_salary</span><span class="p">():</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">DataStats</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">ds</span><span class="o">.</span><span class="n">_avg_salary</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">55165</span>
</pre></div>


<p>a new <code>_avg_salary()</code> method</p>
<div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">_avg_salary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</pre></div>


<p>and a new version of the final return value</p>
<div class="highlight"><pre><span></span>        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;avg_age&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_avg_age</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
            <span class="s1">&#39;avg_salary&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_avg_salary</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
            <span class="s1">&#39;avg_yearly_increase&#39;</span><span class="p">:</span> <span class="n">yearly_avg_increase</span><span class="p">,</span>
            <span class="s1">&#39;max_salary&#39;</span><span class="p">:</span> <span class="n">max_salary</span><span class="p">,</span>
            <span class="s1">&#39;min_salary&#39;</span><span class="p">:</span> <span class="n">min_salary</span>
        <span class="p">}</span>
</pre></div>


<h1>Step 6 - Isolate the average yearly increase algorithm</h1>
<p>Commit: <a href="https://github.com/lgiordani/datastats/commit/4005145f39d36fda0519127d57e1b4099d24e72b">4005145</a></p>
<p>The remaining three keys are computed with algorithms that, being longer than one line, couldn't be squeezed directly in the definition of the dictionary. The refactoring process, however, does not really change; as before, we first test a helper method, then we define it duplicating the code, and last we call the helper removing the code duplication.</p>
<p>For the average yearly increase of the salary we have a new test</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test__avg_yearly_increase</span><span class="p">():</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">DataStats</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">ds</span><span class="o">.</span><span class="n">_avg_yearly_increase</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20000</span><span class="p">)</span> <span class="o">==</span> <span class="mi">837</span>
</pre></div>


<p>a new method that passes the test</p>
<div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">_avg_yearly_increase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">iage</span><span class="p">,</span> <span class="n">isalary</span><span class="p">):</span>
        <span class="c1"># iage and isalary are the starting age and salary used to</span>
        <span class="c1"># compute the average yearly increase of salary.</span>

        <span class="c1"># Compute average yearly increase</span>
        <span class="n">average_age_increase</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span>
            <span class="nb">sum</span><span class="p">([</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">-</span> <span class="n">iage</span>
        <span class="n">average_salary_increase</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span>
            <span class="nb">sum</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">-</span> <span class="n">isalary</span>

        <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">average_salary_increase</span><span class="o">/</span><span class="n">average_age_increase</span><span class="p">)</span>
</pre></div>


<p>and a new version of the <code>_stats()</code> method</p>
<div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">iage</span><span class="p">,</span> <span class="n">isalary</span><span class="p">):</span>
        <span class="c1"># Compute max salary</span>
        <span class="n">salaries</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="s1">&#39;Â£&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">salaries</span><span class="p">))</span>

        <span class="n">max_salary</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">threshold</span><span class="p">]</span>

        <span class="c1"># Compute min salary</span>
        <span class="n">salaries</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="n">min_salary</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">]</span> <span class="o">==</span>
                      <span class="s1">&#39;Â£{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">salaries</span><span class="p">)))]</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;avg_age&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_avg_age</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
            <span class="s1">&#39;avg_salary&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_avg_salary</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
            <span class="s1">&#39;avg_yearly_increase&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_avg_yearly_increase</span><span class="p">(</span>
                <span class="n">data</span><span class="p">,</span> <span class="n">iage</span><span class="p">,</span> <span class="n">isalary</span><span class="p">),</span>
            <span class="s1">&#39;max_salary&#39;</span><span class="p">:</span> <span class="n">max_salary</span><span class="p">,</span>
            <span class="s1">&#39;min_salary&#39;</span><span class="p">:</span> <span class="n">min_salary</span>
        <span class="p">}</span>
</pre></div>


<p>Please note that we are not solving any code duplication but the ones that we introduce to refactor. The first achievement we should aim to is to completely isolate independent features.</p>
<h1>Step 7 - Isolate max and min salary algorithms</h1>
<p>Commit: <a href="https://github.com/lgiordani/datastats/commit/17b24138e712f9174b072a579a2dfc9e2800e6ac">17b2413</a></p>
<p>When refactoring we shall always do one thing at a time, but for the sake of conciseness, I'll show here the result of two refactoring steps at once. I'll recommend the reader to perform them as independent steps, as I did when I wrote the code that I am posting below.</p>
<p>The new tests are</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test__max_salary</span><span class="p">():</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">DataStats</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">ds</span><span class="o">.</span><span class="n">_max_salary</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span> <span class="o">==</span> <span class="p">[{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Garth&quot;</span><span class="p">,</span>
        <span class="s2">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Fields&quot;</span><span class="p">,</span>
        <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span>
        <span class="s2">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;Â£70472&quot;</span>
    <span class="p">}]</span>


<span class="k">def</span> <span class="nf">test__min_salary</span><span class="p">():</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">DataStats</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">ds</span><span class="o">.</span><span class="n">_min_salary</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span> <span class="o">==</span> <span class="p">[{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Laith&quot;</span><span class="p">,</span>
        <span class="s2">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Simmons&quot;</span><span class="p">,</span>
        <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">68</span><span class="p">,</span>
        <span class="s2">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;Â£27888&quot;</span>
    <span class="p">}]</span>
</pre></div>


<p>The new methods in the <code>DataStats</code> class are</p>
<div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">_max_salary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># Compute max salary</span>
        <span class="n">salaries</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="s1">&#39;Â£&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">salaries</span><span class="p">))</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">threshold</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_min_salary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># Compute min salary</span>
        <span class="n">salaries</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">]</span> <span class="o">==</span>
                <span class="s1">&#39;Â£{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">salaries</span><span class="p">)))]</span>
</pre></div>


<p>and the <code>_stats()</code> method is now really tiny</p>
<div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">iage</span><span class="p">,</span> <span class="n">isalary</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;avg_age&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_avg_age</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
            <span class="s1">&#39;avg_salary&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_avg_salary</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
            <span class="s1">&#39;avg_yearly_increase&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_avg_yearly_increase</span><span class="p">(</span>
                <span class="n">data</span><span class="p">,</span> <span class="n">iage</span><span class="p">,</span> <span class="n">isalary</span><span class="p">),</span>
            <span class="s1">&#39;max_salary&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_salary</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
            <span class="s1">&#39;min_salary&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_salary</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="p">}</span>
</pre></div>


<h1>Step 8 - Reducing code duplication</h1>
<p>Commit: <a href="https://github.com/lgiordani/datastats/commit/b559a5c91ef58e1e734ac97b676468d09a460a45">b559a5c</a></p>
<p>Now that we have the main tests in place we can start changing the code of the various helper methods. These are now small enough to allow us to change the code without further tests. While this can be true in this case, however, in general there is no definition of what "small enough" means, as there is no real definition of what "unit test" is. Generally speaking you should be confident that the change that you are doing is covered by the tests that you have. Weren't this the case, you'd better add one or more tests until you feel confident enough.</p>
<p>The two methods <code>_max_salary()</code> and <code>_min_salary()</code> share a great deal of code, even though the second one is more concise</p>
<div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">_max_salary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># Compute max salary</span>
        <span class="n">salaries</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="s1">&#39;Â£&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">salaries</span><span class="p">))</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">threshold</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_min_salary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># Compute min salary</span>
        <span class="n">salaries</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">]</span> <span class="o">==</span>
                <span class="s1">&#39;Â£{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">salaries</span><span class="p">)))]</span>
</pre></div>


<p>I'll start by making explicit the <code>threshold</code> variable in the second function. As soon as I change something, I'll run the tests to check that the external behaviour did not change.</p>
<div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">_max_salary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># Compute max salary</span>
        <span class="n">salaries</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="s1">&#39;Â£&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">salaries</span><span class="p">))</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">threshold</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_min_salary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># Compute min salary</span>
        <span class="n">salaries</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="s1">&#39;Â£{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">salaries</span><span class="p">)))</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">threshold</span><span class="p">]</span>
</pre></div>


<p>Now, it is pretty evident that the two functions are the same but for the <code>min()</code> and <code>max()</code> functions. They still use different variable names and different code to format the threshold, so my first action is to even out them, copying the code of <code>_min_salary()</code> to <code>_max_salary()</code> and changing <code>min()</code> to <code>max()</code></p>
<div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">_max_salary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># Compute max salary</span>
        <span class="n">salaries</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="s1">&#39;Â£{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">salaries</span><span class="p">)))</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">threshold</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_min_salary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># Compute min salary</span>
        <span class="n">salaries</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="s1">&#39;Â£{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">salaries</span><span class="p">)))</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">threshold</span><span class="p">]</span>
</pre></div>


<p>Now I can create another helper called <code>_select_salary()</code> that duplicates that code and accepts a function, used instead of <code>min()</code> or <code>max()</code>. As I did before, first I duplicate the code, and then remove the duplication by calling the new function.</p>
<p>After some passages, the code looks like this</p>
<div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">_select_salary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="n">salaries</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="s1">&#39;Â£{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="n">salaries</span><span class="p">)))</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">threshold</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_max_salary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_salary</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">max</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_min_salary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_salary</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">min</span><span class="p">)</span>
</pre></div>


<p>I noticed then a code duplication between <code>_avg_salary()</code> and <code>_select_salary()</code>:</p>
<div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">_avg_salary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</pre></div>


<div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">_select_salary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="n">salaries</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
</pre></div>


<p>and decided to extract the common algorithm in a method called <code>_salaries()</code>. As before, I write the test first</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_salaries</span><span class="p">():</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">DataStats</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">ds</span><span class="o">.</span><span class="n">_salaries</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="mi">27888</span><span class="p">,</span> <span class="mi">67137</span><span class="p">,</span> <span class="mi">70472</span><span class="p">]</span>
</pre></div>


<p>then I implement the method</p>
<div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">_salaries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
</pre></div>


<p>and eventually I replace the duplicated code with a call to the new method</p>
<div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">_salaries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
</pre></div>


<div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">_select_salary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="s1">&#39;Â£{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_salaries</span><span class="p">(</span><span class="n">data</span><span class="p">))))</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">threshold</span><span class="p">]</span>
</pre></div>


<p>While doing this I noticed that <code>_avg_yearly_increase()</code> contains the same code, and fix it there as well.</p>
<div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">_avg_yearly_increase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">iage</span><span class="p">,</span> <span class="n">isalary</span><span class="p">):</span>
        <span class="c1"># iage and isalary are the starting age and salary used to</span>
        <span class="c1"># compute the average yearly increase of salary.</span>

        <span class="c1"># Compute average yearly increase</span>
        <span class="n">average_age_increase</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span>
            <span class="nb">sum</span><span class="p">([</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">-</span> <span class="n">iage</span>
        <span class="n">average_salary_increase</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span>
            <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_salaries</span><span class="p">(</span><span class="n">data</span><span class="p">))</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">-</span> <span class="n">isalary</span>

        <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">average_salary_increase</span><span class="o">/</span><span class="n">average_age_increase</span><span class="p">)</span>
</pre></div>


<p>It would be useful at this point to store the input data inside the class and to use it as <code>self.data</code> instead of passing it around to all the class's methods. This however would break the class's API, as currently <code>DataStats</code> is initialised without any data. Later I will show how to introduce changes that potentially break the API, and briefly discuss the issue. For the moment, however, I'll keep changing the class without modifying the external interface.</p>
<p>It looks like <code>age</code> has the same code duplication issues as <code>salary</code>, so with the same procedure I introduce the <code>_ages()</code> method and change the <code>_avg_age()</code> and <code>_avg_yearly_increase()</code> methods accordingly.</p>
<p>Speaking of <code>_avg_yearly_increase()</code>, the code of that method contains the code of the <code>_avg_age()</code> and <code>_avg_salary()</code> methods, so it is worth replacing it with two calls. As I am moving code between existing methods, I do not need further tests.</p>
<div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">_avg_yearly_increase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">iage</span><span class="p">,</span> <span class="n">isalary</span><span class="p">):</span>
        <span class="c1"># iage and isalary are the starting age and salary used to</span>
        <span class="c1"># compute the average yearly increase of salary.</span>

        <span class="c1"># Compute average yearly increase</span>
        <span class="n">average_age_increase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_avg_age</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">iage</span>
        <span class="n">average_salary_increase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_avg_salary</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">isalary</span>

        <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">average_salary_increase</span><span class="o">/</span><span class="n">average_age_increase</span><span class="p">)</span>
</pre></div>


<h1>Step 9 - Advanced refactoring</h1>
<p>Commit: <a href="https://github.com/lgiordani/datastats/commit/cc0b0a105ebc882cb73831b177e881bb65f4b491">cc0b0a1</a></p>
<p>The initial class didn't have any <code>__init__()</code> method, and was thus missing the encapsulation part of the object-oriented paradigm. There was no reason to keep the class, as the <code>stats()</code> method could have easily been extracted and provided as a plain function.</p>
<p>This is much more evident now that we refactored the method, because we have 10 methods that accept <code>data</code> as a parameter. I would be nice to load the input data into the class at instantiation time, and then access it as <code>self.data</code>. This would greatly improve the readability of the class, and also justify its existence.</p>
<p>If we introduce a <code>__init__()</code> method that requires a parameter, however, we will change the class's API, breaking the compatibility with every other code that imports and uses it. Since we want to keep it, we have to devise a way to provide both the advantages of a new, clean class and of a stable API. This is not always perfectly achievable, but in this case the <a href="https://en.wikipedia.org/wiki/Adapter_pattern">Adapter design pattern</a> (also known as Wrapper) can perfectly solve the issue.</p>
<p>The goal is to change the current class to match the new API, and then build a class that wraps the first one and provides the old API. The strategy is not that different from what we did previously, only this time we will deal with classes instead of methods. With a stupendous effort of my imagination I named the new class <code>NewDataStats</code>. Sorry, but sometimes you just have to get the job done.</p>
<p>The first things, as happens very often with refactoring, is to duplicate the code, and when we insert new code we need to have tests that justify it. The tests will be the same as before, as the new class shall provide the same functionalities as the previous one, so I just create a new file, called <code>test_newdatastats.py</code> and start putting there the first test <code>test_init()</code>.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">datastats.datastats</span> <span class="kn">import</span> <span class="n">NewDataStats</span>


<span class="n">test_data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Laith&quot;</span><span class="p">,</span>
        <span class="s2">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Simmons&quot;</span><span class="p">,</span>
        <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">68</span><span class="p">,</span>
        <span class="s2">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;Â£27888&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Mikayla&quot;</span><span class="p">,</span>
        <span class="s2">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Henry&quot;</span><span class="p">,</span>
        <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">49</span><span class="p">,</span>
        <span class="s2">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;Â£67137&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Garth&quot;</span><span class="p">,</span>
        <span class="s2">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Fields&quot;</span><span class="p">,</span>
        <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span>
        <span class="s2">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;Â£70472&quot;</span>
    <span class="p">}</span>
<span class="p">]</span>


<span class="k">def</span> <span class="nf">test_init</span><span class="p">():</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">NewDataStats</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">ds</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="n">test_data</span>
</pre></div>


<p>This test doesn't pass, and the code that implements the class is very simple</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">NewDataStats</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
</pre></div>


<p>Now I can start an iterative process:</p>
<ol>
<li>I will copy one of the tests of <code>DataStats</code> and adapt it to <code>NewDataStats</code></li>
<li>I will copy come code from <code>DataStats</code> to <code>NewDataStats</code>, adapting it to the new API and making it pass the test.</li>
</ol>
<p>At this point iteratively removing methods from <code>DataStats</code> and replacing them with a call to <code>NewDataStats</code> would be overkill. I'll show you in the next section why, and what we can do to avoid  that.</p>
<p>An example of the resulting tests for <code>NewDataStats</code> is the following</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_ages</span><span class="p">():</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">NewDataStats</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">ds</span><span class="o">.</span><span class="n">_ages</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span><span class="mi">68</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">70</span><span class="p">]</span>
</pre></div>


<p>and the code that passes the test is</p>
<div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">_ages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">]</span>
</pre></div>


<p>Once finished, I noticed that, as now methods like <code>_ages()</code> do not require an input parameter any more, I can convert them to properties, changing the tests accordingly.</p>
<div class="highlight"><pre><span></span>    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_ages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">]</span>
</pre></div>


<p>It is time to replace the methods of <code>DataStats</code> with calls to <code>NewDataStats</code>. We could do it method by method, bu actually the only thing that we really need is to replace <code>stats()</code>. So the new code is</p>
<div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">iage</span><span class="p">,</span> <span class="n">isalary</span><span class="p">):</span>
        <span class="n">nds</span> <span class="o">=</span> <span class="n">NewDataStats</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nds</span><span class="o">.</span><span class="n">stats</span><span class="p">(</span><span class="n">iage</span><span class="p">,</span> <span class="n">isalary</span><span class="p">)</span>
</pre></div>


<p>And since all the other methods are no more used we can safely delete them, checking that the tests do not fail. Speaking of tests, removing method will make many tests of <code>DataStats</code> fail, so we need to remove them.</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DataStats</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">iage</span><span class="p">,</span> <span class="n">isalary</span><span class="p">):</span>
        <span class="n">nds</span> <span class="o">=</span> <span class="n">NewDataStats</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nds</span><span class="o">.</span><span class="n">stats</span><span class="p">(</span><span class="n">iage</span><span class="p">,</span> <span class="n">isalary</span><span class="p">)</span>
</pre></div>


<h2>Final words</h2>
<p>I hope this little tour of a refactoring session didn't result too trivial, and helped you to grasp the basic concepts of this technique. If you are interested in the subject I'd strongly recommend the classic book by Martin Fowler "Refactoring: Improving the Design of Existing Code", which is a collection of refactoring patterns. The reference language is Java, but the concepts are easily adapted to Python.</p>
<h2>Feedback</h2>
<p>Feel free to use <a href="https://plus.google.com/u/0/111444750762335924049">the blog Google+ page</a> to comment the post. Feel free to reach me on <a href="https://twitter.com/thedigicat">Twitter</a> if you have questions. The <a href="http://github.com/TheDigitalCatOnline/thedigitalcatonline.github.com/issues">GitHub issues</a> page is the best place to submit corrections.</p>
            </div> <!-- /.entry-content -->

<section class="well" id="related-posts">
    <h4>Related Posts:</h4>
    <ul>
        <li><a href="http://blog.thedigitalcatonline.com/blog/2015/09/10/python-oop-tdd-example-part2/">A simple example of Python OOP development (with TDD) - Part 2</a></li>
        <li><a href="http://blog.thedigitalcatonline.com/blog/2016/09/27/python-mocks-a-gentle-introduction-part-2/">Python Mocks: a gentle introduction - Part 2</a></li>
        <li><a href="http://blog.thedigitalcatonline.com/blog/2016/03/06/python-mocks-a-gentle-introduction-part-1/">Python Mocks: a gentle introduction - Part 1</a></li>
        <li><a href="http://blog.thedigitalcatonline.com/blog/2015/05/13/python-oop-tdd-example-part1/">A simple example of Python OOP development (with TDD) - Part 1</a></li>
        <li><a href="http://blog.thedigitalcatonline.com/blog/2017/07/12/a-game-of-tokens-solution-part-1/">A game of tokens: solution - Part 1</a></li>
    </ul>
</section>


                
        </section>
    </article>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<section class="well well-sm">
    <ul class="list-group list-group-flush">
            <li class="list-group-item"><h4><i class="fa fa-cloud fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="https://twitter.com/thedigicat"><i class="fa fa-twitter-square fa-lg"></i> Twitter</a></li>
                <li class="list-group-item"><a href="https://plus.google.com/u/0/111444750762335924049"><i class="fa fa-google-plus-square fa-lg"></i> Google+</a></li>
                <li class="list-group-item"><a href="https://github.com/TheDigitalCatOnline"><i class="fa fa-github-square fa-lg"></i> GitHub</a></li>
              </ul>
            </li>

            <li class="list-group-item"><h4><i class="fa fa-feed fa-lg"></i><span class="icon-label">Feeds</span></h4>
                <ul class="list-group">
                        <li class="list-group-item"><a href="http://blog.thedigitalcatonline.com/atom.xml">The Digital Cat</a></li>


                        <li class="list-group-item"><a href="http://blog.thedigitalcatonline.com/category/programming/atom.xml">Programming</a></li>
                </ul>
            </li>

            <li class="list-group-item"><h4><i class="fa fa-calendar fa-lg"></i><span class="icon-label">Recent Posts</span></h4>
                <ul class="list-group" id="recentposts">
                    <li class="list-group-item">
                        <a href="http://blog.thedigitalcatonline.com/blog/2017/07/21/refactoring-with-test-in-python-a-practical-example/">
                            Refactoring with tests in Python: a practical example
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="http://blog.thedigitalcatonline.com/blog/2017/07/12/a-game-of-tokens-solution-part-1/">
                            A game of tokens: solution - Part 1
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="http://blog.thedigitalcatonline.com/blog/2017/05/09/a-game-of-tokens-write-an-interpreter-in-python-with-tdd-part-1/">
                            A game of tokens: write an interpreter in Python with TDD - Part 1
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="http://blog.thedigitalcatonline.com/blog/2016/11/14/clean-architectures-in-python-a-step-by-step-example/">
                            Clean architectures in Python: a step-by-step example
                        </a>
                    </li>
                </ul>
            </li>


            <li class="list-group-item"><a href="http://blog.thedigitalcatonline.com/"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
                <ul class="list-group list-inline tagcloud" id="tags-side">
                    <li class="list-group-item tag-4">
                        <a href="http://blog.thedigitalcatonline.com/categories/amqp/">
                            AMQP
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://blog.thedigitalcatonline.com/categories/architectures/">
                            architectures
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="http://blog.thedigitalcatonline.com/categories/c/">
                            C
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://blog.thedigitalcatonline.com/categories/clojure/">
                            Clojure
                        </a>
                    </li>
                    <li class="list-group-item tag-3">
                        <a href="http://blog.thedigitalcatonline.com/categories/compilers/">
                            compilers
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="http://blog.thedigitalcatonline.com/categories/concurrent-programming/">
                            concurrent programming
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://blog.thedigitalcatonline.com/categories/cpp/">
                            C++
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="http://blog.thedigitalcatonline.com/categories/decorators/">
                            decorators
                        </a>
                    </li>
                    <li class="list-group-item tag-3">
                        <a href="http://blog.thedigitalcatonline.com/categories/django/">
                            Django
                        </a>
                    </li>
                    <li class="list-group-item tag-3">
                        <a href="http://blog.thedigitalcatonline.com/categories/erlang/">
                            Erlang
                        </a>
                    </li>
                    <li class="list-group-item tag-1">
                        <a href="http://blog.thedigitalcatonline.com/categories/functional-programming/">
                            functional programming
                        </a>
                    </li>
                    <li class="list-group-item tag-3">
                        <a href="http://blog.thedigitalcatonline.com/categories/generators/">
                            generators
                        </a>
                    </li>
                    <li class="list-group-item tag-3">
                        <a href="http://blog.thedigitalcatonline.com/categories/git/">
                            Git
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="http://blog.thedigitalcatonline.com/categories/metaclasses/">
                            metaclasses
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="http://blog.thedigitalcatonline.com/categories/metaprogramming/">
                            metaprogramming
                        </a>
                    </li>
                    <li class="list-group-item tag-3">
                        <a href="http://blog.thedigitalcatonline.com/categories/notebook/">
                            Notebook
                        </a>
                    </li>
                    <li class="list-group-item tag-1">
                        <a href="http://blog.thedigitalcatonline.com/categories/oop/">
                            OOP
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="http://blog.thedigitalcatonline.com/categories/operating-systems/">
                            operating systems
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://blog.thedigitalcatonline.com/categories/pika/">
                            Pika
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://blog.thedigitalcatonline.com/categories/postage/">
                            Postage
                        </a>
                    </li>
                    <li class="list-group-item tag-1">
                        <a href="http://blog.thedigitalcatonline.com/categories/python/">
                            Python
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="http://blog.thedigitalcatonline.com/categories/python2/">
                            Python2
                        </a>
                    </li>
                    <li class="list-group-item tag-1">
                        <a href="http://blog.thedigitalcatonline.com/categories/python3/">
                            Python3
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://blog.thedigitalcatonline.com/categories/qt/">
                            Qt
                        </a>
                    </li>
                    <li class="list-group-item tag-3">
                        <a href="http://blog.thedigitalcatonline.com/categories/rabbitmq/">
                            RabbitMQ
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://blog.thedigitalcatonline.com/categories/refactoring/">
                            refactoring
                        </a>
                    </li>
                    <li class="list-group-item tag-1">
                        <a href="http://blog.thedigitalcatonline.com/categories/scala/">
                            Scala
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="http://blog.thedigitalcatonline.com/categories/tdd/">
                            TDD
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="http://blog.thedigitalcatonline.com/categories/testing/">
                            testing
                        </a>
                    </li>
                    <li class="list-group-item tag-3">
                        <a href="http://blog.thedigitalcatonline.com/categories/versioning/">
                            versioning
                        </a>
                    </li>
                </ul>
            </li>




    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
    <div class="container">
        <hr>
        <div class="row">
            <div class="col-xs-10">&copy; 2017 Leonardo Giordani
                &middot; Powered by <a href="https://github.com/lgiordani/laces3" target="_blank">laces3</a>,
                <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
                <a href="http://getbootstrap.com" target="_blank">Bootstrap 3</a>


                <p><small>  <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-sa/4.0/80x15.png" /></a>
    Content
  licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>, except where indicated otherwise.
</small></p>

            </div>
            <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
        </div>
    </div>
</footer>
<!-- JQuery JS START -->
<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<!-- JQuery JS END -->

<!-- Bootstrap JS START -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<!-- Bootstrap JS END -->


<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<!-- Respond JS START -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js"></script>
<!-- Respond JS END -->



<!-- Begin Cookie Consent -->
<script>
    window.cookieconsent_options = {
        
        message: "This website uses cookies to ensure you get the best experience on our website.",
        learnMore: "More info",
        link: "http://cookielawinfo.com/about/",
        theme: 'http://blog.thedigitalcatonline.com/theme/css/cookieconsent2/dark-top.css',
    };
</script>
<script src="http://blog.thedigitalcatonline.com/theme/js/cookieconsent.min.js"></script>
<!-- End Cookie Consent -->

        <script type="text/javascript">var addthis_config = {"data_track_addressbar": true};</script>
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-56d7f22eee8b0ddf"></script>


</body>
</html>