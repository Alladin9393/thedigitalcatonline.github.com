






















<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>A game of tokens: write an interpreter in Python with TDD - Part 3 - The Digital Cat</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Liquid tags START -->
    <!-- Liquid tags START -->
    
    <link href="http://blog.thedigitalcatonline.com/images/TheDigitalCat_favicon_32.png" rel="icon">

<link rel="canonical" href="http://blog.thedigitalcatonline.com/blog/2017/10/31/a-game-of-tokens-write-an-interpreter-in-python-with-tdd-part-3/">

        <meta name="author" content="Leonardo Giordani" />
        <meta name="keywords" content="Python,Python3,TDD,testing,compilers" />

        <meta property="og:site_name" content="The Digital Cat" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="A game of tokens: write an interpreter in Python with TDD - Part 3"/>
        <meta property="og:url" content="http://blog.thedigitalcatonline.com/blog/2017/10/31/a-game-of-tokens-write-an-interpreter-in-python-with-tdd-part-3/"/>
        <meta property="og:description" content=""/>
        <meta property="article:published_time" content="2017-10-31" />
            <meta property="article:section" content="Programming" />
            <meta property="article:tag" content="Python" />
            <meta property="article:tag" content="Python3" />
            <meta property="article:tag" content="TDD" />
            <meta property="article:tag" content="testing" />
            <meta property="article:tag" content="compilers" />
            <meta property="article:author" content="Leonardo Giordani" />


    <!-- Bootstrap and Bootswatch CSS START -->
            <link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.5/spacelab/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap and Bootswatch CSS END -->

    <!-- Font Awesome CSS START -->
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Font Awesome CSS END -->

    <!-- Pygments CSS START -->
    <link href="http://blog.thedigitalcatonline.com/theme/css/pygments/monokai.css" rel="stylesheet">
    <!-- Pygments CSS END -->

    <!-- Custom CSS START -->
    <!-- Custom CSS END -->
    
    <!-- Docutils CSS START -->
    <!-- Docutils CSS START -->
    


    
    <link rel="stylesheet" href="http://blog.thedigitalcatonline.com/theme/css/style.css" type="text/css"/>
    


        <link href="http://blog.thedigitalcatonline.com/atom.xml" type="application/atom+xml" rel="alternate"
              title="The Digital Cat ATOM Feed"/>



        <link href="http://blog.thedigitalcatonline.com/category/programming/atom.xml" type="application/atom+xml" rel="alternate"
              title="The Digital Cat Programming ATOM Feed"/>

    <!-- Google Analytics Universal -->
    <script type="text/javascript">
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-74364524-1', 'auto');
        ga('send', 'pageview');
    </script>
    <!-- End Google Analytics Universal Code -->

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://blog.thedigitalcatonline.com/" class="navbar-brand">


<i class="fa fa-paw fa-lg"></i>                <span class="icon-label">The Digital Cat</span>
               
            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="http://blog.thedigitalcatonline.com/pages/about.html">
                             About
                          </a></li>
                        <li class="active">
                            <a href="http://blog.thedigitalcatonline.com/category/programming/">Programming</a>
                        </li>
                        <li >
                            <a href="http://blog.thedigitalcatonline.com/category/projects/">Projects</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="http://blog.thedigitalcatonline.com/archives"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<!-- Banner START -->
<!-- Banner END -->

<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <article>
        <header class="page-header">
            <h1>
                <a href="http://blog.thedigitalcatonline.com/blog/2017/10/31/a-game-of-tokens-write-an-interpreter-in-python-with-tdd-part-3/"
                   rel="bookmark"
                   title="Permalink to A game of tokens: write an interpreter in Python with TDD - Part 3">
                    A game of tokens: write an interpreter in Python with TDD - Part 3
                </a>
            </h1>
        </header>

        <section id="content">
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">


            <span class="label label-default">By</span>
            <a href="http://blog.thedigitalcatonline.com/authors/leonardo-giordani/">Leonardo Giordani</a>

            <span class="label label-default">On</span>
            <span class="published">
                <time datetime="2017-10-31T11:00:00+00:00"> 31/10/2017</time>
            </span>







            <span class="label label-default">Series</span>
            Part 5 of "A game of tokens"




    

        <span class="label label-default">Tags</span>
	<a href="http://blog.thedigitalcatonline.com/categories/python/">Python</a>
        /
	<a href="http://blog.thedigitalcatonline.com/categories/python3/">Python3</a>
        /
	<a href="http://blog.thedigitalcatonline.com/categories/tdd/">TDD</a>
        /
	<a href="http://blog.thedigitalcatonline.com/categories/testing/">testing</a>
        /
	<a href="http://blog.thedigitalcatonline.com/categories/compilers/">compilers</a>
    


    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>This is the third instalment of a series of posts on how to write an interpreter in Python. In the <a href="/blog/2017/05/09/a-game-of-tokens-write-an-interpreter-in-python-with-tdd-part-1">first part</a> we developed together a small command line calculator that could sum and subtract numbers, while in the <a href="/blog/2017/10/01/a-game-of-tokens-write-an-interpreter-in-python-with-tdd-part-2">second part</a> we went further adding multiplication, division and unary plus and minus. Both parts give only the tests your code is supposed to pass, and my personal solution can be found <a href="/blog/2017/07/12/a-game-of-tokens-solution-part-1">here</a> for the first part, and <a href="/blog/2017/10/17/a-game-of-tokens-solution-part-2">here</a> for the second.</p>
<p>In this third part we wil start adding variables to our calculator, moving towards a real programming language.</p>
<h1>Level 13 - Variables</h1>
<p><em>I have been assigned by my strength and cunning.</em></p>
<p>Variables are labels assigned to values, so what we need to add is a way for the user to make this assignment and then to use variables intead of actual values. The simplest syntax, used by many languages is <code>name = value</code> and we will stick to this. Usually languages allow only a subset of symbols in the name of a variable and we will learn how to use lower- and uppercase names that may also contain an underscore.</p>
<h2>Lexer</h2>
<p>We want the lexer to recognise a new token called <code>NAME</code>, so the test we have to add to <code>tests/test_calc_lexer.py</code> is</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_get_tokens_understands_letters</span><span class="p">():</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">clex</span><span class="o">.</span><span class="n">CalcLexer</span><span class="p">()</span>

    <span class="n">l</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;somevar&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">l</span><span class="o">.</span><span class="n">get_tokens</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span>
        <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">clex</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span> <span class="s1">&#39;somevar&#39;</span><span class="p">),</span>
        <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">clex</span><span class="o">.</span><span class="n">EOL</span><span class="p">),</span>
        <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">clex</span><span class="o">.</span><span class="n">EOF</span><span class="p">)</span>
    <span class="p">]</span>
</pre></div>


<p>This test checks only the support for lowercase letters. Since we want to support also uppercase letters and underscores we need another pair of test</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_get_tokens_understands_uppercase_letters</span><span class="p">():</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">clex</span><span class="o">.</span><span class="n">CalcLexer</span><span class="p">()</span>

    <span class="n">l</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;SomeVar&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">l</span><span class="o">.</span><span class="n">get_tokens</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span>
        <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">clex</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span> <span class="s1">&#39;SomeVar&#39;</span><span class="p">),</span>
        <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">clex</span><span class="o">.</span><span class="n">EOL</span><span class="p">),</span>
        <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">clex</span><span class="o">.</span><span class="n">EOF</span><span class="p">)</span>
    <span class="p">]</span>


<span class="k">def</span> <span class="nf">test_get_tokens_understands_names_with_underscores</span><span class="p">():</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">clex</span><span class="o">.</span><span class="n">CalcLexer</span><span class="p">()</span>

    <span class="n">l</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;some_var&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">l</span><span class="o">.</span><span class="n">get_tokens</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span>
        <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">clex</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span> <span class="s1">&#39;some_var&#39;</span><span class="p">),</span>
        <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">clex</span><span class="o">.</span><span class="n">EOL</span><span class="p">),</span>
        <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">clex</span><span class="o">.</span><span class="n">EOF</span><span class="p">)</span>
    <span class="p">]</span>
</pre></div>


<h2>Parser</h2>
<p>To support variables in expressions we need to change the behaviour of <code>parse_factor()</code>, which is the method where we parse the building blocks like integers of unary operators. The test you need to add to <code>tests/test_calc_parser.py</code> is</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_parse_factor_variable</span><span class="p">():</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">cpar</span><span class="o">.</span><span class="n">CalcParser</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">lexer</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;somevar&quot;</span><span class="p">)</span>

    <span class="n">node</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parse_factor</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">node</span><span class="o">.</span><span class="n">asdict</span><span class="p">()</span> <span class="o">==</span> <span class="p">{</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;variable&#39;</span><span class="p">,</span>
        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;somevar&#39;</span>
    <span class="p">}</span>
</pre></div>


<p>After this we want to provide support for variable assignments. Working on the parser we need only to output the correct node so the test is pretty straightforward</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_parse_assignment</span><span class="p">():</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">cpar</span><span class="o">.</span><span class="n">CalcParser</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">lexer</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;x = 5&quot;</span><span class="p">)</span>

    <span class="n">node</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parse_assignment</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">node</span><span class="o">.</span><span class="n">asdict</span><span class="p">()</span> <span class="o">==</span> <span class="p">{</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;assignment&#39;</span><span class="p">,</span>
        <span class="s1">&#39;variable&#39;</span><span class="p">:</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span>
        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">5</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre></div>


<p>This test tries to assign the value <code>5</code> to the variable <code>x</code>, but in general we want to support assignment with expressions, so we should test this behaviour as well</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_parse_assignment_with_expression</span><span class="p">():</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">cpar</span><span class="o">.</span><span class="n">CalcParser</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">lexer</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;x = 4 * (3 + 5)&quot;</span><span class="p">)</span>

    <span class="n">node</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parse_assignment</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">node</span><span class="o">.</span><span class="n">asdict</span><span class="p">()</span> <span class="o">==</span> <span class="p">{</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;assignment&#39;</span><span class="p">,</span>
        <span class="s1">&#39;variable&#39;</span><span class="p">:</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span>
        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;binary&#39;</span><span class="p">,</span>
            <span class="s1">&#39;operator&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;literal&#39;</span><span class="p">,</span>
                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;*&#39;</span>
            <span class="p">},</span>
            <span class="s1">&#39;left&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span>
                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">4</span>
            <span class="p">},</span>
            <span class="s1">&#39;right&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;binary&#39;</span><span class="p">,</span>
                <span class="s1">&#39;operator&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;literal&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;+&#39;</span>
                <span class="p">},</span>
                <span class="s1">&#39;left&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">3</span>
                <span class="p">},</span>
                <span class="s1">&#39;right&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">5</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre></div>


<h2>Visitor</h2>
<p>It is now time to implement the code that actually stores and retrieves variables, which is what happens in the visitor when an <code>assignment</code> or a <code>variable</code> node are processed. For the moment we do not have specific requirements for variables and we can treat the storage space as a big global dictionary.</p>
<p>The test we want to pass specifies the initial API of the storage space when we assign a value to a variable</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_visitor_assignment</span><span class="p">():</span>
    <span class="n">ast</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;assignment&#39;</span><span class="p">,</span>
        <span class="s1">&#39;variable&#39;</span><span class="p">:</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span>
        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">5</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">v</span> <span class="o">=</span> <span class="n">cvis</span><span class="o">.</span><span class="n">CalcVisitor</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">v</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">ast</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span><span class="o">.</span><span class="n">isvariable</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">True</span>
    <span class="k">assert</span> <span class="n">v</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span>
    <span class="k">assert</span> <span class="n">v</span><span class="o">.</span><span class="n">typeof</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;integer&#39;</span>
</pre></div>


<p>We want the visitor to provide three new methods, <code>isvariable()</code>, <code>valueof()</code>, and <code>typeof()</code>, that allow us to interact with the variables we defined.</p>
<p>The last change that the visitor requires is some code that allows it to read the value of variables to be able to use them when computing the result of an expression. The test is then</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_visitor_variable</span><span class="p">():</span>
    <span class="n">assignment_ast</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;assignment&#39;</span><span class="p">,</span>
        <span class="s1">&#39;variable&#39;</span><span class="p">:</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span>
        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">123</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">read_ast</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;variable&#39;</span><span class="p">,</span>
        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;x&#39;</span>
    <span class="p">}</span>

    <span class="n">v</span> <span class="o">=</span> <span class="n">cvis</span><span class="o">.</span><span class="n">CalcVisitor</span><span class="p">()</span>
    <span class="n">v</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">assignment_ast</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">v</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">read_ast</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">123</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">)</span>
</pre></div>


<p>where two different ASTs have been created. The first one assigns a value to the variable, the second one reads it and returns its value. Note that the visitor returns both value and type of the variable, which seems reasonable to implement later checks of equality or other operations on variables.</p>
<h1>Level 14 - Parsing expressions and assignments</h1>
<p><em>Speak words we can all understand!</em></p>
<p>We are missing a final step. The CLI uses <code>parse_expression()</code> as its default entry point, which means that it doesn't understand variable assignments for the time being. We need then to introduce a new entry point <code>parse_line()</code> that we will use to process general language statements. The test for this goes in <code>tests/test_calc_parser.py</code></p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_parse_line_supports_expression</span><span class="p">():</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">cpar</span><span class="o">.</span><span class="n">CalcParser</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">lexer</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;2 * 3 + 4&quot;</span><span class="p">)</span>

    <span class="n">node</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parse_line</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">node</span><span class="o">.</span><span class="n">asdict</span><span class="p">()</span> <span class="o">==</span> <span class="p">{</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;binary&#39;</span><span class="p">,</span>
        <span class="s1">&#39;left&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;binary&#39;</span><span class="p">,</span>
            <span class="s1">&#39;left&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span>
                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">2</span>
            <span class="p">},</span>
            <span class="s1">&#39;right&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span>
                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">3</span>
            <span class="p">},</span>
            <span class="s1">&#39;operator&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;literal&#39;</span><span class="p">,</span>
                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;*&#39;</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="s1">&#39;right&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">4</span>
        <span class="p">},</span>
        <span class="s1">&#39;operator&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;literal&#39;</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;+&#39;</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre></div>


<p>and checks that <code>parse_line()</code> can parse expressions (which can be solved just wrapping <code>parse_expression()</code> with it). The second test checks that <code>parse_line()</code> can parse variable assignments and goes in the same file</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_parse_line_supports_assigment</span><span class="p">():</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">cpar</span><span class="o">.</span><span class="n">CalcParser</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">lexer</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;x = 5&quot;</span><span class="p">)</span>

    <span class="n">node</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parse_line</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">node</span><span class="o">.</span><span class="n">asdict</span><span class="p">()</span> <span class="o">==</span> <span class="p">{</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;assignment&#39;</span><span class="p">,</span>
        <span class="s1">&#39;variable&#39;</span><span class="p">:</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span>
        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">5</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre></div>


<p>At this point we can change the entry point in the CLI, using <code>parse_line()</code> instead of <code>parse_expression()</code>. The new CLI is then</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">smallcalc</span> <span class="kn">import</span> <span class="n">calc_parser</span> <span class="k">as</span> <span class="n">cpar</span>
<span class="kn">from</span> <span class="nn">smallcalc</span> <span class="kn">import</span> <span class="n">calc_visitor</span> <span class="k">as</span> <span class="n">cvis</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">cpar</span><span class="o">.</span><span class="n">CalcParser</span><span class="p">()</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">cvis</span><span class="o">.</span><span class="n">CalcVisitor</span><span class="p">()</span>

    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;smallcalc :&gt; &#39;</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">lexer</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

            <span class="n">node</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parse_line</span><span class="p">()</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">asdict</span><span class="p">())</span>

            <span class="k">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">EOFError</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Bye!&quot;</span><span class="p">)</span>
            <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
            <span class="k">continue</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>


<p>Try to fire the CLI and enjoy a calculator with variables! Everything works, but you now know it is not magic, but the outcome of a good amount of code. And you wrote it, so you may proudly say that you created a simple but working programming language.</p>
<h1>Conclusion</h1>
<p>Managing variables may look like a very easy task, but as soon as we will start implementing functions and local scopes we will have to move to something richer than a simple global dictionary. Memory management is another big topic that I didn't touch here, perhaps in the future I might discuss garbage collections and related problems.
In the next issue I will face with you the task of adding the power operator, support for floating point numbers, and a big refactoring with context managers that will greatly simplify the code.</p>
<h1>Titles</h1>
<p>The section quotes come from some good films: "Up" (2009), "The Lord of the Rings: The Fellowship of the Ring" (2001).</p>
<h2>Feedback</h2>
<p>Feel free to use <a href="https://plus.google.com/u/0/111444750762335924049">the blog Google+ page</a> to comment the post. Feel free to reach me on <a href="https://twitter.com/thedigicat">Twitter</a> if you have questions. The <a href="http://github.com/TheDigitalCatOnline/thedigitalcatonline.github.com/issues">GitHub issues</a> page is the best place to submit corrections.</p>
            </div> <!-- /.entry-content -->

<section class="well" id="related-posts">
    <h4>Related Posts:</h4>
    <ul>
        <li><a href="http://blog.thedigitalcatonline.com/blog/2017/05/09/a-game-of-tokens-write-an-interpreter-in-python-with-tdd-part-1/">A game of tokens: write an interpreter in Python with TDD - Part 1</a></li>
        <li><a href="http://blog.thedigitalcatonline.com/blog/2017/07/12/a-game-of-tokens-solution-part-1/">A game of tokens: solution - Part 1</a></li>
        <li><a href="http://blog.thedigitalcatonline.com/blog/2017/10/01/a-game-of-tokens-write-an-interpreter-in-python-with-tdd-part-2/">A game of tokens: write an interpreter in Python with TDD - Part 2</a></li>
        <li><a href="http://blog.thedigitalcatonline.com/blog/2017/10/31/a-game-of-tokens-solution-part-3/">A game of tokens: solution - Part 3</a></li>
        <li><a href="http://blog.thedigitalcatonline.com/blog/2017/10/17/a-game-of-tokens-solution-part-2/">A game of tokens: solution - Part 2</a></li>
    </ul>
</section>
<section class="well" id="related-posts">
    <h4>Part 5 of the "A game of tokens" series</h4>
       <h5>Previous articles</h5>
       <ul>
           <li><a href="http://blog.thedigitalcatonline.com/blog/2017/05/09/a-game-of-tokens-write-an-interpreter-in-python-with-tdd-part-1/">A game of tokens: write an interpreter in Python with TDD - Part 1</a></li>
           <li><a href="http://blog.thedigitalcatonline.com/blog/2017/07/12/a-game-of-tokens-solution-part-1/">A game of tokens: solution - Part 1</a></li>
           <li><a href="http://blog.thedigitalcatonline.com/blog/2017/10/01/a-game-of-tokens-write-an-interpreter-in-python-with-tdd-part-2/">A game of tokens: write an interpreter in Python with TDD - Part 2</a></li>
           <li><a href="http://blog.thedigitalcatonline.com/blog/2017/10/17/a-game-of-tokens-solution-part-2/">A game of tokens: solution - Part 2</a></li>
       </ul>
       <h5>Next articles</h5>
       <ul>
           <li><a href="http://blog.thedigitalcatonline.com/blog/2017/10/31/a-game-of-tokens-solution-part-3/">A game of tokens: solution - Part 3</a></li>
       </ul>
</section>

                
        </section>
    </article>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<section class="well well-sm">
    <ul class="list-group list-group-flush">
            <li class="list-group-item"><h4><i class="fa fa-cloud fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="https://twitter.com/thedigicat"><i class="fa fa-twitter-square fa-lg"></i> Twitter</a></li>
                <li class="list-group-item"><a href="https://plus.google.com/u/0/111444750762335924049"><i class="fa fa-google-plus-square fa-lg"></i> Google+</a></li>
                <li class="list-group-item"><a href="https://github.com/TheDigitalCatOnline"><i class="fa fa-github-square fa-lg"></i> GitHub</a></li>
              </ul>
            </li>

            <li class="list-group-item"><h4><i class="fa fa-feed fa-lg"></i><span class="icon-label">Feeds</span></h4>
                <ul class="list-group">
                        <li class="list-group-item"><a href="http://blog.thedigitalcatonline.com/atom.xml">The Digital Cat</a></li>


                        <li class="list-group-item"><a href="http://blog.thedigitalcatonline.com/category/programming/atom.xml">Programming</a></li>
                </ul>
            </li>

            <li class="list-group-item"><h4><i class="fa fa-calendar fa-lg"></i><span class="icon-label">Recent Posts</span></h4>
                <ul class="list-group" id="recentposts">
                    <li class="list-group-item">
                        <a href="http://blog.thedigitalcatonline.com/blog/2017/10/31/a-game-of-tokens-solution-part-3/">
                            A game of tokens: solution - Part 3
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="http://blog.thedigitalcatonline.com/blog/2017/10/31/a-game-of-tokens-write-an-interpreter-in-python-with-tdd-part-3/">
                            A game of tokens: write an interpreter in Python with TDD - Part 3
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="http://blog.thedigitalcatonline.com/blog/2017/10/17/a-game-of-tokens-solution-part-2/">
                            A game of tokens: solution - Part 2
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="http://blog.thedigitalcatonline.com/blog/2017/10/01/a-game-of-tokens-write-an-interpreter-in-python-with-tdd-part-2/">
                            A game of tokens: write an interpreter in Python with TDD - Part 2
                        </a>
                    </li>
                </ul>
            </li>


            <li class="list-group-item"><a href="http://blog.thedigitalcatonline.com/"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
                <ul class="list-group list-inline tagcloud" id="tags-side">
                    <li class="list-group-item tag-4">
                        <a href="http://blog.thedigitalcatonline.com/categories/amqp/">
                            AMQP
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://blog.thedigitalcatonline.com/categories/architectures/">
                            architectures
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="http://blog.thedigitalcatonline.com/categories/c/">
                            C
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://blog.thedigitalcatonline.com/categories/clojure/">
                            Clojure
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="http://blog.thedigitalcatonline.com/categories/compilers/">
                            compilers
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="http://blog.thedigitalcatonline.com/categories/concurrent-programming/">
                            concurrent programming
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://blog.thedigitalcatonline.com/categories/cpp/">
                            C++
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="http://blog.thedigitalcatonline.com/categories/decorators/">
                            decorators
                        </a>
                    </li>
                    <li class="list-group-item tag-3">
                        <a href="http://blog.thedigitalcatonline.com/categories/django/">
                            Django
                        </a>
                    </li>
                    <li class="list-group-item tag-3">
                        <a href="http://blog.thedigitalcatonline.com/categories/erlang/">
                            Erlang
                        </a>
                    </li>
                    <li class="list-group-item tag-1">
                        <a href="http://blog.thedigitalcatonline.com/categories/functional-programming/">
                            functional programming
                        </a>
                    </li>
                    <li class="list-group-item tag-3">
                        <a href="http://blog.thedigitalcatonline.com/categories/generators/">
                            generators
                        </a>
                    </li>
                    <li class="list-group-item tag-3">
                        <a href="http://blog.thedigitalcatonline.com/categories/git/">
                            Git
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="http://blog.thedigitalcatonline.com/categories/metaclasses/">
                            metaclasses
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="http://blog.thedigitalcatonline.com/categories/metaprogramming/">
                            metaprogramming
                        </a>
                    </li>
                    <li class="list-group-item tag-3">
                        <a href="http://blog.thedigitalcatonline.com/categories/notebook/">
                            Notebook
                        </a>
                    </li>
                    <li class="list-group-item tag-1">
                        <a href="http://blog.thedigitalcatonline.com/categories/oop/">
                            OOP
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="http://blog.thedigitalcatonline.com/categories/operating-systems/">
                            operating systems
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://blog.thedigitalcatonline.com/categories/pika/">
                            Pika
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://blog.thedigitalcatonline.com/categories/postage/">
                            Postage
                        </a>
                    </li>
                    <li class="list-group-item tag-1">
                        <a href="http://blog.thedigitalcatonline.com/categories/python/">
                            Python
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="http://blog.thedigitalcatonline.com/categories/python2/">
                            Python2
                        </a>
                    </li>
                    <li class="list-group-item tag-1">
                        <a href="http://blog.thedigitalcatonline.com/categories/python3/">
                            Python3
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://blog.thedigitalcatonline.com/categories/qt/">
                            Qt
                        </a>
                    </li>
                    <li class="list-group-item tag-3">
                        <a href="http://blog.thedigitalcatonline.com/categories/rabbitmq/">
                            RabbitMQ
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://blog.thedigitalcatonline.com/categories/refactoring/">
                            refactoring
                        </a>
                    </li>
                    <li class="list-group-item tag-1">
                        <a href="http://blog.thedigitalcatonline.com/categories/scala/">
                            Scala
                        </a>
                    </li>
                    <li class="list-group-item tag-1">
                        <a href="http://blog.thedigitalcatonline.com/categories/tdd/">
                            TDD
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="http://blog.thedigitalcatonline.com/categories/testing/">
                            testing
                        </a>
                    </li>
                    <li class="list-group-item tag-3">
                        <a href="http://blog.thedigitalcatonline.com/categories/versioning/">
                            versioning
                        </a>
                    </li>
                </ul>
            </li>

                    <li class="list-group-item"><h4><i class="fa fa-tags fa-list-ul"></i><span class="icon-label">Series</span></h4>
                        <ul class="list-group">
                            <li class="list-group-item">
                                <h5></i> Previous article</h5>
                                <a href="http://blog.thedigitalcatonline.com/blog/2017/10/17/a-game-of-tokens-solution-part-2/">A game of tokens: solution - Part 2</a>
                            </li>
                            <li class="list-group-item">
                                <h5>Next article</h5>
                                <a href="http://blog.thedigitalcatonline.com/blog/2017/10/31/a-game-of-tokens-solution-part-3/">A game of tokens: solution - Part 3</a>
                            </li>
                        </ul>
                    </li>



    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
    <div class="container">
        <hr>
        <div class="row">
            <div class="col-xs-10">&copy; 2017 Leonardo Giordani
                &middot; Powered by <a href="https://github.com/lgiordani/laces3" target="_blank">laces3</a>,
                <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
                <a href="http://getbootstrap.com" target="_blank">Bootstrap 3</a>


                <p><small>  <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-sa/4.0/80x15.png" /></a>
    Content
  licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>, except where indicated otherwise.
</small></p>

            </div>
            <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
        </div>
    </div>
</footer>
<!-- JQuery JS START -->
<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<!-- JQuery JS END -->

<!-- Bootstrap JS START -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<!-- Bootstrap JS END -->


<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<!-- Respond JS START -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js"></script>
<!-- Respond JS END -->



<!-- Begin Cookie Consent -->
<script>
    window.cookieconsent_options = {
        
        message: "This website uses cookies to ensure you get the best experience on our website.",
        learnMore: "More info",
        link: "http://cookielawinfo.com/about/",
        theme: 'http://blog.thedigitalcatonline.com/theme/css/cookieconsent2/dark-top.css',
    };
</script>
<script src="http://blog.thedigitalcatonline.com/theme/js/cookieconsent.min.js"></script>
<!-- End Cookie Consent -->

        <script type="text/javascript">var addthis_config = {"data_track_addressbar": true};</script>
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-56d7f22eee8b0ddf"></script>


</body>
</html>